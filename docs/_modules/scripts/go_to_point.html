

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>scripts.go_to_point &mdash; rt2_assignment2 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> rt2_assignment2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">rt2_assignment2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>scripts.go_to_point</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for scripts.go_to_point</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: go_to_point</span>
<span class="sd">    :platform: Unix</span>
<span class="sd">    :synopsis: This file implements the behaviour that allows the robot to reach a goal.</span>

<span class="sd">.. moduleauthor:: Zoe Betta</span>

<span class="sd">This node allows the robot to reach a position with a given orientation.</span>
<span class="sd">Firstly it orients the robot in the direction of the goal and moves towards it.</span>
<span class="sd">Once the robot has reached the correct x and y coordinates it rotates to reach</span>
<span class="sd">the correct orientation. The velocities, both angular and linear are set by</span>
<span class="sd">the node *user_interface* and are received on the topic */vel*. If the goal</span>
<span class="sd">is set cancelled by the client of the action server then the velocities are</span>
<span class="sd">all set to zero and the action server is set preempted.  </span>
<span class="sd"> </span>
<span class="sd">Subscribes to:</span>

<span class="sd">/odom topic where the simulator publishes the robot position</span>

<span class="sd">/vel where the *user_interface* publishes the requested velocities</span>

<span class="sd">Publishes to:</span>

<span class="sd">/cmd_vel the desired robot velocity, it depends on the state</span>

<span class="sd">Service :</span>

<span class="sd">/go_to_point to start the robot motion.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">Odometry</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">actionlib.msg</span>
<span class="kn">import</span> <span class="nn">rt2_assignment2.msg</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float64</span>

<span class="c1"># robot state variables</span>
<span class="n">position_</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Point: actual robot position</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">pose_</span><span class="o">=</span><span class="n">Pose</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Pose: actual robot orientation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">yaw_</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot;Float: actual robot angle</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">position_</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">state_</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot;Int: state of the server</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">pub_</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;To publish on the */cmd_vel* topic</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">desired_position_</span><span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Point: desired robot position</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">desired_position_</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span>
<span class="sd">&quot;&quot;&quot;Float: desired robot orientation</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
<span class="sd">&quot;&quot;&quot;Bool: to store wheater the goal has been reached</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">yaw_precision_</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">9</span> 
<span class="sd">&quot;&quot;&quot;Float: +/- 20 degrees of precision allowed</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">yaw_precision_2_</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">90</span>
<span class="sd">&quot;&quot;&quot;Float: +/- 2 degrees of precision allowed</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">dist_precision_</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="sd">&quot;&quot;&quot;Float: precision of the linear distace allowed</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">kp_a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span>
<span class="sd">&quot;&quot;&quot;Float: coefficent</span>
<span class="sd">&quot;&quot;&quot;</span> 
<span class="n">kp_d</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="sd">&quot;&quot;&quot;Float: coefficent</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">ub_a</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="sd">&quot;&quot;&quot;Float: coefficent</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">lb_a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="sd">&quot;&quot;&quot;Float: coefficent</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">ub_d</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="sd">&quot;&quot;&quot;Float: coefficent</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">Vel</span><span class="o">=</span><span class="n">Twist</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Twist: the requested velocities</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">act_s</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;To initialize the action server</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="euler_from_quaternion"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.euler_from_quaternion">[docs]</a><span class="k">def</span> <span class="nf">euler_from_quaternion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a quaternion into euler angles (roll, pitch, yaw)</span>
<span class="sd">    roll is rotation around x in radians (counterclockwise)</span>
<span class="sd">    pitch is rotation around y in radians (counterclockwise)</span>
<span class="sd">    yaw is rotation around z in radians (counterclockwise)</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        x,y,z,w (Float): the elements of the quaternion</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        Roll_x,pitch_y,yaw_z (Float) : the euler angles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">roll_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
     
    <span class="n">t2</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="n">z</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="o">+</span><span class="mf">1.0</span> <span class="k">else</span> <span class="n">t2</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">else</span> <span class="n">t2</span>
    <span class="n">pitch_y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
     
    <span class="n">t3</span> <span class="o">=</span> <span class="o">+</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">yaw_z</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="n">t4</span><span class="p">)</span>
     
    <span class="k">return</span> <span class="n">roll_x</span><span class="p">,</span> <span class="n">pitch_y</span><span class="p">,</span> <span class="n">yaw_z</span> <span class="c1"># in radians</span></div>

<div class="viewcode-block" id="clbk_vel"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.clbk_vel">[docs]</a><span class="k">def</span> <span class="nf">clbk_vel</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function saves the data received by the subscriber on the topic */vel*</span>
<span class="sd">    in a global variable of type Twist, Vel, this variable will be used when</span>
<span class="sd">    there is the need to set a new velocity.</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        msg(Twist): the data received on the topic */vel*</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">Vel</span>
    <span class="n">Vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
    <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span></div>

<div class="viewcode-block" id="clbk_odom"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.clbk_odom">[docs]</a><span class="k">def</span> <span class="nf">clbk_odom</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function saves the data received by the subscriber on the topic */odom*</span>
<span class="sd">    in the global variable position for the information about the current position</span>
<span class="sd">    of the robot. It then changes the format of the orientation from quaternions angles</span>
<span class="sd">    to euler angles; it is the extracted the third elemen of the vector and it is saved</span>
<span class="sd">    on the global variable *yaw_*</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        msg (Odometry): the data received on the topic */odom*</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#This is called when new data are available on /odom</span>
    <span class="k">global</span> <span class="n">position_</span>
    <span class="k">global</span> <span class="n">pose_</span>
    <span class="k">global</span> <span class="n">yaw_</span>
	
    <span class="c1"># position</span>
    <span class="n">position_</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span>

    <span class="c1"># yaw</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
    <span class="n">euler</span> <span class="o">=</span> <span class="n">euler_from_quaternion</span><span class="p">(</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">yaw_</span> <span class="o">=</span> <span class="n">euler</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>

<div class="viewcode-block" id="change_state"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.change_state">[docs]</a><span class="k">def</span> <span class="nf">change_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function receives the new state and assigns its value to the global </span>
<span class="sd">    variable *states_*. Then a message is printed to know which one is the</span>
<span class="sd">    new state.</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        state(Int): the state of the robot</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Changes the state to a new one</span>
    <span class="k">global</span> <span class="n">state_</span>
    <span class="n">state_</span> <span class="o">=</span> <span class="n">state</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;State changed to [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">state_</span><span class="p">)</span></div>

<div class="viewcode-block" id="normalize_angle"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.normalize_angle">[docs]</a><span class="k">def</span> <span class="nf">normalize_angle</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function normalizes the angle received as input, it doesn&#39;t change </span>
<span class="sd">    the sign but it reduces the magnitude to less than one full circle</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        angle(Float): the angle I want to normalize</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        angle(Float): the normalized angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#This makes calculations on angles</span>
    <span class="k">if</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">angle</span></div>

<div class="viewcode-block" id="fix_yaw"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.fix_yaw">[docs]</a><span class="k">def</span> <span class="nf">fix_yaw</span><span class="p">(</span><span class="n">des_pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the desired orientation to reach the x,y point</span>
<span class="sd">    and set the angular velocity to reach it. If the orientation error is </span>
<span class="sd">    less than a given threshold then the state is changed to the behaviour</span>
<span class="sd">    go straight.</span>
<span class="sd">   </span>
<span class="sd">    Args :</span>
<span class="sd">        des_pos (Point): the desired x and y coordinates</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#This orients the robot in direction of the goal</span>
    <span class="k">global</span> <span class="n">yaw_</span><span class="p">,</span> <span class="n">pub</span><span class="p">,</span> <span class="n">yaw_precision_2_</span><span class="p">,</span> <span class="n">state_</span><span class="p">,</span><span class="n">Vel</span>
    <span class="n">des_yaw</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">desired_position_</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">desired_position_</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">err_yaw</span> <span class="o">=</span> <span class="n">normalize_angle</span><span class="p">(</span><span class="n">des_yaw</span> <span class="o">-</span> <span class="n">yaw_</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span>
    
    <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">yaw_precision_2_</span><span class="p">:</span>
        <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
        <span class="k">if</span> <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">ub_a</span><span class="p">:</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
        <span class="k">elif</span> <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">lb_a</span><span class="p">:</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
    <span class="n">pub_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
    <span class="c1"># state change conditions</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">yaw_precision_2_</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Yaw error: [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">err_yaw</span><span class="p">)</span>
        <span class="n">change_state</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="go_straight_ahead"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.go_straight_ahead">[docs]</a><span class="k">def</span> <span class="nf">go_straight_ahead</span><span class="p">(</span><span class="n">des_pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This function calculates the desired orientation to reach the x,y point and the distance between the goal both linear and angular, It then sets the linear velocity, It also set an angular velocity proportional to the error to slightly correct the direction of the line when needed, If the distance between the goal is less than a given threshold the state is changed to the fix final orientation behaviour.</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        des_pos (Point): the desired x and y coordinates</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#This makes the robot go in a straight line towards the goal</span>
    <span class="k">global</span> <span class="n">yaw_</span><span class="p">,</span> <span class="n">pub</span><span class="p">,</span> <span class="n">yaw_precision_</span><span class="p">,</span> <span class="n">state_</span><span class="p">,</span><span class="n">Vel</span>
    <span class="n">des_yaw</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">desired_position_</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">desired_position_</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">err_yaw</span> <span class="o">=</span> <span class="n">des_yaw</span> <span class="o">-</span> <span class="n">yaw_</span>
    <span class="n">err_pos</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">desired_position_</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">desired_position_</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">position_</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">err_yaw</span> <span class="o">=</span> <span class="n">normalize_angle</span><span class="p">(</span><span class="n">des_yaw</span> <span class="o">-</span> <span class="n">yaw_</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err_pos</span> <span class="o">&gt;</span> <span class="n">dist_precision_</span><span class="p">:</span>
        <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
        <span class="n">twist_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">twist_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">ub_d</span><span class="p">:</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>

        <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="o">*</span><span class="n">err_yaw</span>
        <span class="n">pub_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># state change conditions</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Position error: [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">err_pos</span><span class="p">)</span>
        <span class="n">change_state</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># state change conditions</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">yaw_precision_</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Yaw error: [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">err_yaw</span><span class="p">)</span>
        <span class="n">change_state</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="fix_final_yaw"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.fix_final_yaw">[docs]</a><span class="k">def</span> <span class="nf">fix_final_yaw</span><span class="p">(</span><span class="n">des_yaw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the error between the current orientation and the </span>
<span class="sd">    desired one. It then sets the angular velocity to obtain the correct orientation.</span>
<span class="sd">    If the error is less than a given threshold then the state is changed to done.</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        des_yaw(Float): the desired orientation</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">Vel</span>
	<span class="c1"># It orients the robot in the final desired orientation </span>
    <span class="n">err_yaw</span> <span class="o">=</span> <span class="n">normalize_angle</span><span class="p">(</span><span class="n">des_yaw</span> <span class="o">-</span> <span class="n">yaw_</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span>
    <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">yaw_precision_2_</span><span class="p">:</span>
        <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
        <span class="k">if</span> <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">ub_a</span><span class="p">:</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
        <span class="k">elif</span> <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">lb_a</span><span class="p">:</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">Vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>
    <span class="n">pub_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
    <span class="c1"># state change conditions</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">err_yaw</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">yaw_precision_2_</span><span class="p">:</span>
        <span class="c1">#print (&#39;Yaw error: [%s]&#39; % err_yaw)</span>
        <span class="n">change_state</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>
      
<div class="viewcode-block" id="done"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.done">[docs]</a><span class="k">def</span> <span class="nf">done</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function puts to zero all the velocities, angular and linear, and sets</span>
<span class="sd">    the goal as succeeded.  </span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#I put every velocity to zero before setting the goal to completed</span>
    <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="n">twist_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pub_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">act_s</span><span class="o">.</span><span class="n">set_succeeded</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="go_to_point"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.go_to_point">[docs]</a><span class="k">def</span> <span class="nf">go_to_point</span><span class="p">(</span><span class="n">goal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called when a request to the server is made. It sets </span>
<span class="sd">    all the global variables needed, then it enteres a while loop. In the while</span>
<span class="sd">    loop it always check if the goal is preempted and if that is the case it</span>
<span class="sd">    sets all the velocities to zero and it set the goal as preempted. If </span>
<span class="sd">    the action server is not preempted it checks which is the state and it </span>
<span class="sd">    calls the corresponding function.  </span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        goal: the desired position and orientation to obtain</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Implements the logic to go to the goal</span>
    <span class="k">global</span> <span class="n">state_</span><span class="p">,</span> <span class="n">desired_position_</span><span class="p">,</span> <span class="n">act_s</span><span class="p">,</span> <span class="n">success</span>
    <span class="n">desired_position_</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
    <span class="n">desired_position_</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
    <span class="n">des_yaw</span> <span class="o">=</span> <span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span>
    <span class="n">change_state</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
		<span class="c1"># if the action is preempted</span>
        <span class="k">if</span> <span class="n">act_s</span><span class="o">.</span><span class="n">is_preempt_requested</span><span class="p">():</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Goal was preempted&#39;</span><span class="p">)</span>
            <span class="c1"># I set the velocity to zero</span>
            <span class="n">twist_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">twist_msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pub_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist_msg</span><span class="p">)</span>
            <span class="c1"># I set the goal as preempted</span>
            <span class="n">act_s</span><span class="o">.</span><span class="n">set_preempted</span><span class="p">()</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span> 
            <span class="k">break</span>
        <span class="c1">#if the state is 0 I orient the robot towards the goal    </span>
        <span class="k">elif</span> <span class="n">state_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fix_yaw</span><span class="p">(</span><span class="n">desired_position_</span><span class="p">)</span>
        <span class="c1">#if the state is 1 I go straight    </span>
        <span class="k">elif</span> <span class="n">state_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">go_straight_ahead</span><span class="p">(</span><span class="n">desired_position_</span><span class="p">)</span>
        <span class="c1">#if the state is 2 the robot orients itself in the final orientation    </span>
        <span class="k">elif</span> <span class="n">state_</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fix_final_yaw</span><span class="p">(</span><span class="n">des_yaw</span><span class="p">)</span>
        <span class="c1">#if the state is 3 I set the goal as achieved    </span>
        <span class="k">elif</span> <span class="n">state_</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">done</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#scripts.go_to_point.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called when the program is first requested to run. It</span>
<span class="sd">    initializes all the publishers, subscribers, services and then waits for</span>
<span class="sd">    a request for the action server that should come from the user_interface</span>
<span class="sd">    node.</span>
<span class="sd">    </span>
<span class="sd">    Args :</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    Returns :</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">pub_</span><span class="p">,</span> <span class="n">active_</span><span class="p">,</span> <span class="n">act_s</span>
    <span class="c1">#I initialize the goal</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;go_to_point&#39;</span><span class="p">)</span>
    <span class="c1">#I initialize the publisher for the velocity</span>
    <span class="n">pub_</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;/cmd_vel&#39;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#I initialize the subscriber on odometry</span>
    <span class="n">sub_odom</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/odom&#39;</span><span class="p">,</span> <span class="n">Odometry</span><span class="p">,</span> <span class="n">clbk_odom</span><span class="p">)</span>
    <span class="n">sub_linVel</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/vel&#39;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">clbk_vel</span><span class="p">)</span>
    <span class="c1">#I initialize the action server</span>
    <span class="n">act_s</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionServer</span><span class="p">(</span><span class="s1">&#39;/go_to_point&#39;</span><span class="p">,</span> <span class="n">rt2_assignment2</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">PlanningAction</span><span class="p">,</span> <span class="n">go_to_point</span><span class="p">,</span> <span class="n">auto_start</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">act_s</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Zoe Betta.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>